# Docker Stack - Servidor VPS

Este reposit√≥rio cont√©m a configura√ß√£o completa para implantar uma pilha de servi√ßos de auto-hospedagem (self-hosted) em um servidor VPS (Ubuntu 24.04), utilizando Docker e Docker Compose.

O objetivo √© criar uma configura√ß√£o padronizada, segura, versionada e facilmente replic√°vel.

## üéØ Status Atual do Projeto

Este projeto est√° em desenvolvimento ativo. Atualmente, os scripts de bootstrap, limpeza e manuten√ß√£o (`manter_ativo.sh`) est√£o funcionais. Os servi√ßos base como Caddy e PostgreSQL est√£o operacionais, e a configura√ß√£o inicial do n8n via Docker Compose est√° presente.

O servi√ßo Waha est√° em fase de planejamento e implementa√ß√£o. Outros servi√ßos como Cockpit, n8n, Caddy e PostgreSQL j√° est√£o operacionais. Para detalhes sobre o progresso e as pr√≥ximas etapas, consulte nosso [ROADMAP.md](ROADMAP.md).

## üîê Fluxo de Acesso e Seguran√ßa

Este ambiente opera com Caddy como o ponto de entrada principal, fornecendo HTTPS autom√°tico para todos os servi√ßos.
1. O acesso aos servi√ßos √© feito diretamente atrav√©s de seus respectivos subdom√≠nios, por exemplo, `https://n8n.galvani4987.duckdns.org`.
2. A seguran√ßa de cada servi√ßo individual (login, etc.) √© gerenciada pelo pr√≥prio servi√ßo.

## üöÄ Servi√ßos Planejados (Stack Final)

A pilha de servi√ßos **inclui** os seguintes componentes, acessados atrav√©s do Caddy:

* **Caddy:** Proxy reverso moderno e autom√°tico com HTTPS. √â o port√£o de entrada para todos os servi√ßos. (J√° operacional)
* **PostgreSQL:** Banco de dados relacional robusto para aplica√ß√µes. (J√° operacional)
* **n8n:** Plataforma de automa√ß√£o de fluxos de trabalho. (Ex: [https://n8n.galvani4987.duckdns.org](https://n8n.galvani4987.duckdns.org)).
* **Waha:** API HTTP para integra√ß√£o com o WhatsApp **(a ser implementado)** (Ex: [https://waha.galvani4987.duckdns.org](https://waha.galvani4987.duckdns.org)).
* **Cockpit:** Interface para gerenciamento do servidor host (Instalado pelo bootstrap.sh; acesso direto via https://IP_DO_SERVIDOR:9090)

*Nota: Consulte o [ROADMAP.md](ROADMAP.md) para o status atual de implementa√ß√£o de cada servi√ßo.*

## üõ†Ô∏è Scripts de Gerenciamento

Dois scripts essenciais para gerenciamento do servidor:

### `bootstrap.sh`
Prepara um novo servidor com todas as depend√™ncias necess√°rias:
```bash
sudo bash bootstrap.sh
```

### `clean-server.sh`
Reseta completamente o servidor para estado limpo (removendo Docker, resetando firewall, etc.):
```bash
sudo bash clean-server.sh
```

### `manter_ativo.sh` (Cron Job)
Script para manter servi√ßos ativos (executado via cron):
```bash
0 * * * * /home/ubuntu/docker-stack/scripts/manter_ativo.sh
```

## ‚öôÔ∏è Implanta√ß√£o em um Novo Servidor

Este reposit√≥rio √© projetado para uma implanta√ß√£o r√°pida e semi-automatizada.

**Pr√©-requisitos:**
* Um servidor limpo com Ubuntu 24.04.
* Acesso root/sudo.
* O DNS do seu dom√≠nio (`galvani4987.duckdns.org`) j√° apontando para o IP do novo servidor.

**Passos de Implanta√ß√£o:**

1.  **Clone o Reposit√≥rio:**
    ```bash
    # Instale o git primeiro, se necess√°rio: sudo apt update && sudo apt install git -y
    git clone git@github.com:galvani4987/docker-stack.git
    cd docker-stack
    ```

2.  **Execute o Script de Bootstrap:**
    Este script instalar√° depend√™ncias do servidor e preparar√° o ambiente:
    ```bash
    sudo bash bootstrap.sh
    ```
    *Nota: Ap√≥s a execu√ß√£o, o usu√°rio `ubuntu` √© adicionado ao grupo `docker`. Pode ser necess√°rio sair e logar novamente na sess√£o SSH para que as permiss√µes do Docker sejam aplicadas sem `sudo`.*

3.  **Edite seus Segredos:**
    O script de bootstrap criou o arquivo `.env`. Edite-o com suas senhas e tokens:
    ```bash
    nano .env
    ```

4.  **Inicie a Pilha Docker:**
    Com tudo configurado, inicie todos os servi√ßos:
    ```bash
    docker compose up -d
    ```

5.  **Configura√ß√µes Manuais P√≥s-Instala√ß√£o:**
    * **Cron Job (Keep-Alive):** Configure o cron job para o script de atividade:
        ```bash
        crontab -e
        # Adicione a linha:
        0 * * * * /home/ubuntu/docker-stack/scripts/manter_ativo.sh
        ```
    * **Firewall Oracle Cloud:** Libere as portas 80 e 443 no painel da Oracle Cloud

## üîÑ Gerenciamento Di√°rio

Comandos √∫teis para opera√ß√£o do sistema:

| Comando | Descri√ß√£o |
|---------|-----------|
| `docker compose up -d` | Iniciar todos os servi√ßos |
| `docker compose stop` | Parar todos os servi√ßos |
| `docker compose logs -f` | Ver logs em tempo real |
| `docker compose pull` | Atualizar imagens dos servi√ßos |
| `sudo bash clean-server.sh` | Reset completo do servidor |
| `sudo ufw status` | Verificar status do firewall |

## üö® Troubleshooting

Esta se√ß√£o aborda problemas comuns e suas poss√≠veis solu√ß√µes.

### Problema: Certificados SSL n√£o s√£o gerados pelo Caddy

Se voc√™ estiver enfrentando problemas com a emiss√£o de certificados SSL (HTTPS):

*   **Verifique a propaga√ß√£o do DNS:**
    *   Certifique-se de que os registros DNS do seu dom√≠nio (e subdom√≠nios) est√£o corretamente apontados para o endere√ßo IP p√∫blico do servidor.
    *   A propaga√ß√£o de DNS pode levar algum tempo. Utilize ferramentas online como `whatsmydns.net` para verificar o status da propaga√ß√£o para os tipos de registro A ou CNAME.

*   **Analise os logs do Caddy:**
    *   Os logs do Caddy fornecem informa√ß√µes detalhadas sobre o processo de obten√ß√£o de certificados.
    ```bash
    docker compose logs caddy
    ```
    *   Procure por mensagens de erro relacionadas a desafios ACME, timeouts, ou problemas de conectividade.

*   **Confira as configura√ß√µes do Caddyfile:**
    *   Verifique se os nomes de dom√≠nio no seu `config/Caddyfile` est√£o corretos e correspondem aos seus registros DNS.
    *   Certifique-se de que o email fornecido para a Let's Encrypt no Caddyfile √© v√°lido.

*   **Firewall e Portas:**
    *   Caddy precisa que as portas 80 (para desafios HTTP) e 443 (para TLS-ALPN) estejam acess√≠veis publicamente. Verifique o firewall do seu provedor de nuvem e o UFW no servidor:
    ```bash
    sudo ufw status
    ```

### Problema: Servi√ßos n√£o se comunicam entre si ou com o exterior

Se os containers Docker n√£o conseguem se comunicar entre si ou com a internet:

*   **Inspecione a Rede Docker:**
    *   Verifique se todos os servi√ßos relevantes est√£o conectados √† mesma rede Docker (`app-network` neste projeto).
    ```bash
    docker network inspect app-network
    ```
    *   Confirme se os containers aparecem listados na se√ß√£o "Containers" da sa√≠da do comando.

*   **Teste a conectividade interna:**
    *   Voc√™ pode testar a resolu√ß√£o de nome e a conectividade entre containers usando `ping` ou `curl` de dentro de um container.
    *   Primeiro, acesse o shell de um container (ex: o container do Caddy):
        ```bash
        docker compose exec caddy sh
        ```
    *   Dentro do container, tente pingar outro servi√ßo pelo nome definido no `docker-compose.yml` (ex: `ping postgres` ou `ping n8n`).
        ```sh
        # Dentro do container do Caddy
        ping postgres
        ping n8n
        ```
    *   *Nota: Algumas imagens minimalistas podem n√£o incluir `ping` ou `curl`. Use um container que possua essas ferramentas ou instale-as temporariamente se necess√°rio e poss√≠vel.*

*   **Verifique as regras de firewall do host:**
    *   Embora o Docker gerencie suas pr√≥prias regras de iptables, configura√ß√µes restritivas de UFW ou firewalls externos podem interferir. Assegure-se de que as pol√≠ticas `FORWARD` n√£o estejam bloqueando o tr√°fego entre redes Docker ou para o exterior.

*   **Consulte os logs dos servi√ßos envolvidos:**
    *   Logs espec√≠ficos dos containers podem indicar problemas de configura√ß√£o de rede, erros de resolu√ß√£o de nome, ou falhas ao tentar estabelecer conex√µes.
    ```bash
    docker compose logs nome_do_servico_1 nome_do_servico_2
    ```

## ü§ù Contribui√ß√£o
Contribui√ß√µes s√£o bem-vindas! Siga o fluxo:
1. Fork do reposit√≥rio
2. Crie um branch para sua feature (`git checkout -b feature/awesome-feature`)
3. Commit suas mudan√ßas (`git commit -am 'Add awesome feature'`)
4. Push para o branch (`git push origin feature/awesome-feature`)
5. Abra um Pull Request

## üìÑ Licen√ßa
Este projeto est√° licenciado sob a MIT License - veja o arquivo [LICENSE](LICENSE) para detalhes.
