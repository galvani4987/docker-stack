# Authentik Setup Guide

## Introduction

Authentik is an open-source Identity Provider (IdP) that provides Single Sign-On (SSO), Multi-Factor Authentication (MFA), and overall identity management. In this stack, Authentik serves as:
- The central **authentication gateway** for all services.
- The main **landing page** when accessing `https://{$DOMAIN_NAME}`.
- An access point for **Google OAuth**, allowing users to log in with their Google accounts.

This guide will walk you through setting up Authentik, configuring Google OAuth, and securing your applications.

## Prerequisites

Before you begin, ensure you have the following:
- **Docker and Docker Compose:** Installed and running on your server.
- **A Domain Name:** Pointing to your server's public IP address (e.g., `yourdomain.com`). This will be referred to as `{$DOMAIN_NAME}`.
- **Environment Variables:** The main `.env` file (copied from `.env.example`) must be populated with necessary values, especially `DOMAIN_NAME` and `CADDY_EMAIL`.

## Environment Variables for Authentik

The following environment variables in your `.env` file are crucial for Authentik's operation. Ensure these are set before starting the services:

-   `AUTHENTIK_POSTGRES_DB=authentik`: The database name for Authentik. Default is fine.
-   `AUTHENTIK_POSTGRES_USER=authentik`: The PostgreSQL username for Authentik. Default is fine.
-   `AUTHENTIK_POSTGRES_PASSWORD=<generate_a_strong_password_for_authentik_db>`: **Crucial!** Set a strong, unique password for the Authentik database.
-   `AUTHENTIK_SECRET_KEY=<generate_a_strong_secret_key_for_authentik_app>`: **Crucial!** Set a long, random, and unique secret key for Authentik's internal operations (e.g., session encryption). Use a password generator.

-   `AUTHENTIK_EMAIL_HOST=smtp.example.com`: Your SMTP server hostname for sending emails (password resets, notifications).
-   `AUTHENTIK_EMAIL_PORT=587`: Your SMTP server port.
-   `AUTHENTIK_EMAIL_USERNAME=user@example.com`: Your SMTP username.
-   `AUTHENTIK_EMAIL_PASSWORD=<your_smtp_password>`: Your SMTP password.
-   `AUTHENTIK_EMAIL_USE_TLS=true`: Set to `true` if your SMTP provider uses TLS (most common).
-   `AUTHENTIK_EMAIL_USE_SSL=false`: Set to `true` if your SMTP provider uses SSL (less common, TLS is preferred).
-   `AUTHENTIK_EMAIL_FROM=authentik@{$DOMAIN_NAME}`: The "From" address for emails sent by Authentik. Should match your domain. (Certifique-se de que `{$DOMAIN_NAME}` seja substituído pelo seu domínio real no arquivo .env).

-   `AUTHENTIK_TOKEN_N8N=<authentik_outpost_token_for_n8n>`: Placeholder for the token generated by Authentik for the n8n outpost. You will fill this in after UI configuration.
-   `AUTHENTIK_TOKEN_COCKPIT=<authentik_outpost_token_for_cockpit>`: Placeholder for the Cockpit outpost token.
    *(Add more `AUTHENTIK_TOKEN_SERVICENAME` variables as you integrate more services).*

## Initial Authentik Setup (Manual UI Steps)

1.  **Start Services:**
    Bring up the core Authentik services, Caddy, and any applications you intend to protect. It's often easiest to start all services:
    ```bash
    docker compose up -d
    ```
    Or, if you want to start selectively:
    ```bash
    docker compose up -d authentik-postgres authentik-redis authentik-server authentik-worker caddy n8n cockpit # and other apps
    ```

2.  **Access Initial Setup:**
    Open your browser and navigate to `https://{$DOMAIN_NAME}/if/flow/initial-setup/`.
    (Note: `https://auth.{$DOMAIN_NAME}/if/flow/initial-setup/` should also work as an alias).

3.  **Set Admin Password:**
    You will be prompted to create a password for the default admin user, `akadmin`. Choose a strong password and save it securely.

4.  **Log In:**
    After setting the password, you'll be redirected to the login page. Log in with username `akadmin` and the password you just created. The default Authentik interface will be at `https://{$DOMAIN_NAME}/if/hub`.

## Configuring Google OAuth Provider (Manual UI Steps)

This allows users to log in to Authentik (and subsequently your apps) using their Google accounts.

### In Google Cloud Console:

1.  **Create/Select Project:** Go to the [Google Cloud Console](https://console.cloud.google.com/). Create a new project or select an existing one.
2.  **OAuth Consent Screen:**
    *   Navigate to "APIs & Services" -> "OAuth consent screen".
    *   Choose "External" user type.
    *   Fill in the required fields: App name (e.g., "Authentik - {$DOMAIN_NAME}"), User support email, Developer contact information.
    *   Scopes: Add `email`, `profile`, `openid`.
    *   Test users: Add your Google account(s) for testing before publishing.
3.  **Credentials:**
    *   Navigate to "APIs & Services" -> "Credentials".
    *   Click "+ CREATE CREDENTIALS" -> "OAuth client ID".
    *   Application type: "Web application".
    *   Name: (e.g., "Authentik {$DOMAIN_NAME} Web Client").
    *   **Authorized JavaScript origins:** Add `https://{$DOMAIN_NAME}` (and `https://auth.{$DOMAIN_NAME}` if you plan to use it directly for admin access).
    *   **Authorized redirect URIs:** Add `https://{$DOMAIN_NAME}/source/oauth/callback/google/` (or `https://auth.{$DOMAIN_NAME}/source/oauth/callback/google/` if you prefer to use the `auth.` subdomain for this).
    *   Click "CREATE".
    *   Copy the **Client ID** and **Client secret**. You'll need these for Authentik.

### In Authentik UI (Admin Interface):

1.  **Navigate to Sources:**
    In the Authentik admin interface (usually accessed via `https://{$DOMAIN_NAME}/if/admin`), go to "Directory" -> "Federation & Social login" -> "Sources".
2.  **Create Google OAuth Source:**
    *   Click "Create".
    *   Select "Google OAuth Source". Click "Next".
    *   **Name:** `google` (or your preferred name).
    *   **Slug:** `google` (or your preferred slug, will be part of the callback URL).
    *   **Consumer Key:** Paste the Client ID from Google Cloud.
    *   **Consumer Secret:** Paste the Client secret from Google Cloud.
    *   **Scopes:** Ensure `openid`, `email`, `profile` are listed (usually default).
    *   Click "Finish".
3.  **Add Source to Login Flow:**
    *   Go to "Flows & Stages" -> "Flows".
    *   Find the default login flow (often `default-authentication-flow`).
    *   Under "Bindings", edit the `default-authentication-login` stage (or similar).
    *   In the "Social Login" section, select your newly created `google` source.
    *   Click "Update".
    Now, the login page (`https://{$DOMAIN_NAME}/if/flow/default-authentication-flow/`) should show a "Sign in with Google" option.

## Securing Applications with Authentik (Manual UI Steps)

This is the general workflow to protect an application (e.g., n8n) using Authentik's proxy outposts.

**General Workflow:**
`User Request` -> `Caddy (Reverse Proxy)` -> `Authentik Outpost` -> `(Authentication if needed via Authentik Server)` -> `Application`

**Example: Securing n8n**

1.  **Create the Application in Authentik:**
    *   In Authentik Admin: "Applications" -> "Applications".
    *   Click "Create".
    *   **Name:** `n8n` (or your preferred name).
    *   **Slug:** `n8n` (this is for Authentik's internal reference).
    *   **Provider:** Leave blank for now; we'll create and link it next.
    *   **Launch URL:** (Optional, but good for users) `https://n8n.{$DOMAIN_NAME}`. This is where users will be redirected after login if they access n8n from the Authentik dashboard.
    *   Click "Create".

2.  **Create the Proxy Provider:**
    *   In Authentik Admin: "Applications" -> "Providers".
    *   Click "Create".
    *   Select "Proxy Provider". Click "Next".
    *   **Name:** `n8n-proxy` (or similar).
    *   **Authorization flow:** Select the default (`default-provider-authorization-implicit-consent` or a more restrictive one if you've created one).
    *   **Forward auth (single application):**
        *   **External host:** `https://n8n.{$DOMAIN_NAME}` (This is the URL the user sees and Caddy serves).
        *   **Internal host:** `http://n8n:5678` (This is how the outpost reaches the actual n8n service on the Docker network. `http`, not `https` unless n8n itself is configured for https internally).
    *   Click "Finish".

3.  **Link Provider to Application:**
    *   Go back to "Applications" -> "Applications", edit your `n8n` application.
    *   Select the `n8n-proxy` provider you just created in the "Provider" dropdown.
    *   Click "Update".

4.  **Create the Outpost:**
    *   In Authentik Admin: "Applications" -> "Outposts".
    *   Click "Create".
    *   **Name:** `n8n-outpost` (or similar).
    *   **Type:** "Proxy".
    *   **Service connection:** Select "Local docker connection" (or configure one if appropriate for your setup).
    *   **Integration:** Select the `n8n-proxy` provider you created.
    *   **Authentik host:** `https://auth.{$DOMAIN_NAME}` (It's generally recommended to use the `auth.` subdomain here for outposts, as the main domain might change or have different routing). You can also use `https://{$DOMAIN_NAME}` if you prefer, but ensure it consistently points to Authentik's core.
    *   **Log Level:** `info` is usually fine.
    *   Click "Create".
    *   **Important:** After creation, Authentik will display the outpost's configuration, including a **Token**. Copy this token.
    *   Open your `.env` file and paste this token as the value for `AUTHENTIK_TOKEN_N8N`.
    *   Restart the outpost service if it was already running to pick up the new token: `docker compose restart authentik_proxy_n8n`. (Or `docker compose up -d --force-recreate authentik_proxy_n8n`).

**Repeat for Other Services:**

Follow the same Application -> Provider -> Outpost steps for other services:

*   **Cockpit:**
    *   Application Launch URL: `https://cockpit.{$DOMAIN_NAME}`
    *   Provider Internal Host: `http://host.docker.internal:9090` (assuming Cockpit is not a Docker service but running on the host, accessible via this special Docker DNS name). If Cockpit were a Docker service, it would be `http://cockpit:9090`).
    *   Outpost Token: Set `AUTHENTIK_TOKEN_COCKPIT` in `.env`.

After configuring each outpost and setting its token in `.env`, restart the respective proxy service: `docker compose restart authentik_proxy_cockpit`.

## Caddy Configuration Overview

The `config/Caddyfile` is set up to route traffic:
-   `https://{$DOMAIN_NAME}` and `https://auth.{$DOMAIN_NAME}` point to the Authentik server (`authentik-server:9000`).
-   Protected applications like `https://n8n.{$DOMAIN_NAME}` point to their respective Authentik proxy outposts (e.g., `authentik_proxy_n8n:9000`).

Caddy handles HTTPS termination, so all internal communication between Caddy and Authentik services (server and outposts) is over HTTP.

## Accessing Applications

Once configured:
1.  Navigate to an application URL (e.g., `https://n8n.{$DOMAIN_NAME}`).
2.  You will be redirected to Authentik for login (e.g., `https://{$DOMAIN_NAME}/if/...).
3.  Log in using your `akadmin` credentials or Google OAuth.
4.  After successful authentication, you'll be redirected back to the application.

You can see all applications you have access to on the Authentik Hub page: `https://{$DOMAIN_NAME}/if/hub`.

## Troubleshooting

-   **Check Service Logs:**
    -   Authentik Server: `docker compose logs authentik-server`
    -   Authentik Worker: `docker compose logs authentik-worker`
    -   Specific Outpost (e.g., n8n): `docker compose logs authentik_proxy_n8n`
    -   Caddy: `docker compose logs caddy`
-   **Outpost Connectivity:** Ensure the `AUTHENTIK_HOST` in the outpost configuration within Authentik UI is correct and reachable from within the Docker network.
-   **Tokens:** Double-check that the `AUTHENTIK_TOKEN_*` values in your `.env` file exactly match the tokens generated in the Authentik UI for each outpost. Restart the outpost service after any token change.
-   **Provider Configuration:** Verify the "Internal host" in the Provider settings correctly points to the application service and port *as accessible from the outpost container*.
-   **Caddyfile:** Ensure `{$DOMAIN_NAME}` is correctly substituted and that `reverse_proxy` directives point to the correct outpost services and ports.
-   **Clear Browser Cache/Cookies:** Sometimes, old session data or redirects can cause issues. Try an incognito window or clear your browser's cache for your domain.
-   **Authentik Admin UI:** Review configurations for applications, providers, and outposts. Check the "System Logs" within Authentik admin for more detailed error messages.
